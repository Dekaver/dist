import{a as w}from"./api-125ed4f7.js";import{a as j}from"./api-10826abe.js";import{a as z}from"./options-b2eb7ae6.js";import{A as M}from"./index-b9e295bc.js";import"./custom-zod-e9521e5d.js";import{_ as O,r as c,A as R,o as y,c as H,b as i,d as s,l as g,t as h,e as d,n as v,k as f,B,f as J}from"./index-11eb6111.js";import{z as m}from"./index-0ec66d4d.js";const F=m.object({nomor:m.string().nullable(),tanggal:m.date(),id_proyek:m.number().positive().gt(0)}),T=m.object({nama_barang:m.string().min(1),qty:m.number().gte(0),id_satuan:m.number(),harga:m.number().gte(0),note:m.string().nullish(),total:m.number().gte(0)}),K=F.extend({status:m.literal("D"),detail:m.array(T).min(1,{message:"Minimal Satu Produk"})}),Z=F.extend({status:m.literal("C"),detail:m.array(T.extend({qty:m.number().gt(0),harga:m.number().gt(0),total:m.number().gt(0)})).min(1)}),G=m.discriminatedUnion("status",[K,Z]),Q={data(){return{item:{id:null,nomor:null,tanggal:null,id_proyek:null,total:0,dpp:0,grandtotal:0,detail:[{type:"produk",id_barang:null,nama_barang:null,note:null,qty:null,id_satuan:null,satuan:null,diambil:null,sisa:null,harga:null,total:null,optionSatuan:[]}]},nullDetail:null,lProyek:[],filteredProyek:[],selectedproyek:null,lProduk:[],filteredProduk:[],lSatuan:[],columns:[{field:"nama_barang",header:"Nama Barang",width:"15%",class:"left"},{field:"qty",header:"Kuantitas",width:"15%",class:"left",type:"number"},{field:"satuan",header:"Satuan",width:"15%",class:"left"},{field:"harga",header:"Harga Satuan",width:"15%",class:"right",type:"currency"},{field:"total",header:"Jumlah",width:"15%",class:"right",type:"currency"}],isClean:!0,isEdit:!1}},computed:{subtotal(){return this.item.detail.reduce((a,e)=>a+parseFloat(e.total||0),0)},FormError(){var a,e;return this.isClean?{}:((e=(a=G.safeParse(this.FormItem))==null?void 0:a.error)==null?void 0:e.format())||{}},FormItem(){return{...this.item,detail:this.item.detail.filter(a=>a.nama_barang!=null)}}},mounted(){this.item.id=this.$route.params.id,this.isEdit=!!this.$route.params.id,this.$isLoading.value=!0,this.nullDetail={...this.item.detail[0]},this.getData().finally(()=>{this.isEdit?this.getRencanaAnggaranBiaya():(this.item.status="D",this.item.tanggal=new Date),this.$timeoutLoading()}),this.item.created_name=this.$auth.nama},methods:{onCellEditComplete(a){let{data:e,newValue:l,field:p}=a;switch(p){case"nama_barang":if(typeof l=="string"||l==null){e[p]=l,this.item.detail.some(n=>n.nama_barang==null)||this.tambahBarisDetail();return}e.id_satuan=l.id_satuan,e.option_satuan=l.option_satuan,e.selectedSatuan=e.option_satuan.find(n=>n.id==l.id_satuan),e.qty=0,e.harga=parseFloat(l.harga_jual),e.total=e.harga*e.qty,e.kode_barang=l.kode_barang,e.id_barang=l.id,e[p]=l.nama_barang,this.item.detail.some(n=>n.nama_barang==null)||this.tambahBarisDetail();break;case"selectedSatuan":if(!l)return;e[p]=l,e.id_satuan=l.id,e.harga=e.harga/l.konversi*(a.value?a.value.konversi:1),e.total=e.harga*e.qty;break;case"qty":typeof l=="number"?(e[p]=l,e.total=e.harga*l):e[p]=0;break;case"harga":e[p]=l,e.total=e.qty*l;break;default:e[p]=l;break}},async getRencanaAnggaranBiaya(){await w.show(this.item.id).then(a=>{this.item={...a.data.data,detail:a.data.data.detail.map(e=>{if(e.id_barang){const l=this.lProduk.find(p=>p.id==e.id_barang);return{...e,type:"produk",option_satuan:l.option_satuan,selectedSatuan:l.option_satuan.find(p=>p.id==e.id_satuan)}}else return{...e,type:"jasa",option_satuan:[],selectedSatuan:this.lSatuan.find(l=>l.id==e.id_satuan)}})},this.item.tanggal=new Date(this.item.tanggal),this.selectedproyek=this.lProyek.find(e=>e.id==this.item.id_proyek),this.item.detail.forEach(e=>{})}).finally(()=>{this.item.status=="D"&&this.tambahBarisDetail()})},async getData(){await j.index().then(a=>{this.lProyek=a.data.data}).catch(a=>{this.$toast.add({severity:"error",summary:"Failed",detail:a.response.data.message,life:3e3})}),await z.getProduk().then(a=>{this.lProduk=a.data.data}).catch(a=>{this.$toast.add({severity:"error",summary:"Failed",detail:a.response.data.message,life:3e3})})},selectProyek(a){this.item.id_proyek=a.value.id},searchProyek(a){setTimeout(()=>{this.filteredProyek=a.query.trim().length?this.lProyek.filter(e=>e.proyek.toLowerCase().includes(a.query.trim().toLowerCase())):[...this.lProyek]},250)},updateProyek(){this.item.detail=[],this.tambahBarisDetail()},searchProduk(a){setTimeout(()=>{this.filteredProduk=a.query.trim().length?this.lProduk.filter(e=>e.nama_barang.toLowerCase().includes(a.query.trim().toLowerCase())):[...this.lProduk]},250)},searchAllProduk(){setTimeout(()=>{this.filteredProduk=this.lProduk.filter(a=>!this.item.detail.some(e=>e.nama_barang==a.nama_barang))},250)},tambahBarisDetail(){this.item.detail.push({...this.nullDetail})},switchType(a){const e=this.item.detail[a].type=this.item.detail[a].type=="produk"?"jasa":"produk";this.item.detail[a]={...this.nullDetail,type:e}},hapusBarisDetail(a){this.item.detail.length!=1&&(this.item.detail=this.item.detail.filter(e=>e!==a))},async Save(a="D"){const e=this.item.status;try{if(this.isClean=!1,this.$isLoading.value=!0,this.item.status=a,this.item.total=this.subtotal,Object.keys(this.FormError).length>0){console.log(this.FormError),this.item.status=e;return}this.isEdit?await w.update(this.item.id,this.FormItem).then(l=>{this.$toast.add({severity:"success",summary:"Successful",detail:l.data.message,life:3e3})}):await w.store(this.FormItem).then(l=>{this.item.id=l.data.data.id,this.item.nomor=l.data.data.nomor,this.item.created_by=l.data.data.created_by,this.$toast.add({severity:"success",summary:"Successful",detail:l.data.message,life:3e3}),setTimeout(()=>{this.isEdit=!0,this.$router.replace({name:"rencana-anggaran-biaya.edit",params:{id:this.item.id}})},1200),this.isEdit=!0})}catch(l){if(l instanceof m.ZodError)return;l instanceof M&&this.$toast.add({severity:"error",summary:"Failed",detail:l.response.data.message,life:3e3}),this.item.status=e,console.log(l)}finally{this.$timeoutLoading()}}}},W={class:"grid"},X={class:"col-12"},Y={class:"card"},$={class:"p-fluid formgrid grid"},ee={class:"field col-12 md:col-4"},te={class:"field col-12 md:col-4"},ae={class:"field col-12 md:col-4"},le={class:"grid"},oe={class:"col-12"},ie={class:"text-green-500"},se={class:"font-bold",style:{"white-space":"nowrap","text-overflow":"ellipsis"}},ne=i("div",{class:"field col-12"},null,-1),re={class:"col-12 my-4"},de={class:"flex align-items-center gap-2"},me={class:"flex flex-column"},ue={class:"text-green-500"},ce={class:"flex flex-column"},he={class:""},pe=i("div",{class:"col-12 md:col-6 xl:col-4 mb-2"},null,-1),ge=i("div",{class:"xl:col-4"},null,-1),_e={class:"col-12 md:col-6 xl:col-4"},ye={class:"grid py-3 justify-content-center align-items-center"},be=i("div",{class:"col-7 md:col-6"},"Total",-1),fe={class:"col-5 md:col-6 text-right"},ke=i("br",null,null,-1),ve={class:"grid"},Ce=i("div",{class:"col-6"},null,-1),we={class:"col-6"},Ve={class:"flex flex-wrap gap-3 justify-content-end"},De=i("div",{class:"flex align-items-center justify-content-center"},[i("i",{class:"pi pi-exclamation-triangle mr-3",style:{"font-size":"2rem"}}),i("span",null,"Enter the reason for canceling")],-1);function Se(a,e,l,p,n,u){const U=c("Toast"),L=c("Tag"),C=c("Label"),V=c("InputText"),b=c("ErrorMsg"),q=c("Calendar"),D=c("AutoComplete"),_=c("Column"),k=c("Button"),S=c("Textarea"),x=c("InputNumber"),P=c("Dropdown"),N=c("DataTable"),I=c("SubmitButton"),A=c("Dialog"),E=R("select-all-text");return y(),H("div",W,[i("div",X,[i("div",Y,[s(U),i("h5",null,[g(h(n.isEdit?"Ubah":"Tambah")+" Rencana Anggaran Biaya ",1),s(L,{style:{float:"right"},value:a.$h.getLabel(n.item.status),severity:a.$h.getLabel(n.item.status)},null,8,["value","severity"])]),i("div",$,[i("div",ee,[s(C,{generated:"",for:"sonumber"},{default:d(()=>[g("Nomor")]),_:1}),s(V,{id:"sonumber",type:"text",modelValue:n.item.nomor,"onUpdate:modelValue":e[0]||(e[0]=t=>n.item.nomor=t),class:v(u.FormError.nomor&&"p-invalid"),disabled:""},null,8,["modelValue","class"]),s(b,{error:u.FormError.nomor},null,8,["error"])]),i("div",te,[s(C,{required:"",class:"mb-1"},{default:d(()=>[g("Tanggal")]),_:1}),s(q,{dateFormat:"dd-mm-yy",modelValue:n.item.tanggal,"onUpdate:modelValue":e[1]||(e[1]=t=>n.item.tanggal=t),inputId:"tanggal",class:v(u.FormError.tanggal&&"p-invalid"),showButtonBar:""},null,8,["modelValue","class"]),s(b,{error:u.FormError.tanggal},null,8,["error"])]),i("div",ae,[s(C,{required:"",for:"proyek"},{default:d(()=>[g("Proyek")]),_:1}),s(D,{modelValue:n.selectedproyek,"onUpdate:modelValue":e[2]||(e[2]=t=>n.selectedproyek=t),suggestions:n.filteredProyek,optionLabel:"proyek",onComplete:u.searchProyek,onItemSelect:u.selectProyek,onChange:u.updateProyek,dropdown:"",class:v(u.FormError.id_proyek&&"p-invalid")},{option:d(({option:t})=>[i("div",le,[i("div",oe,[i("div",ie,h(t.kode),1),i("div",se,h(t.proyek),1)])])]),_:1},8,["modelValue","suggestions","onComplete","onItemSelect","onChange","class"]),s(b,{error:u.FormError.id_proyek},null,8,["error"])]),ne,i("div",re,[s(N,{value:n.item.detail,editMode:"cell",onCellEditComplete:u.onCellEditComplete,tableClass:"editable-cells-table p-datatable-small",tableStyle:"table-layout: auto;"},{default:d(()=>[s(_,{header:"#",headerStyle:"width:10px;"},{body:d(({index:t})=>[g(h(t+1),1)]),_:1}),s(_,{header:"Tipe",headerStyle:"width:5%;"},{body:d(({data:t,index:o})=>[i("div",de,[s(k,{onClick:r=>u.switchType(o),icon:t.type=="produk"?"pi pi-box":"pi pi-briefcase",severity:t.type=="produk"?"primary":"secondary"},null,8,["onClick","icon","severity"])])]),_:1}),s(_,{field:"nama_barang",header:"Nama Barang"},{body:d(({data:t,field:o,index:r})=>[i("span",me,[i("small",ue,h(t.kode_barang),1),i("span",null,h(t[o]),1),s(b,{error:u.FormError.detail},null,8,["error"])])]),editor:d(({data:t,field:o})=>[t.type=="produk"?(y(),f(D,{key:0,modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r,suggestions:n.filteredProduk,optionLabel:"nama_barang",virtualScrollerOptions:{itemSize:50},onComplete:u.searchProduk,class:"min-w-max",dropdown:"",onDropdownClick:u.searchAllProduk},{option:d(r=>[i("div",ce,[i("small",{class:v(r.option.is_stok?"text-green-500":"text-blue-500")},h(r.option.kode_barang),3),i("div",he,h(r.option.nama_barang),1)])]),_:2},1032,["modelValue","onUpdate:modelValue","suggestions","onComplete","onDropdownClick"])):(y(),f(V,{key:1,modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r,name:"nama_barang",class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue"]))]),_:1}),s(_,{field:"deskripsi",header:"Spesifikasi"},{body:d(({data:t,field:o})=>[g(h(t[o]),1)]),editor:d(({data:t,field:o})=>[s(S,{modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(_,{field:"qty",header:"Kuantitas"},{body:d(({data:t,field:o})=>[g(h(t[o]?a.$h.formatNumber(t[o]):null),1)]),editor:d(({data:t,field:o})=>[B(s(x,{modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r,minFractionDigits:1,maxFractionDigits:2,min:0,class:"min-w-max",disabled:t.nama_barang==null},null,8,["modelValue","onUpdate:modelValue","disabled"]),[[E]])]),_:1}),s(_,{field:"selectedSatuan",header:"Satuan"},{body:d(({data:t,field:o})=>{var r;return[g(h((r=t[o])==null?void 0:r.satuan),1)]}),editor:d(({data:t,field:o})=>[t.type=="produk"?(y(),f(P,{key:0,modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r,options:t.option_satuan,optionLabel:"satuan",class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue","options"])):(y(),f(P,{key:1,modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r,options:n.lSatuan,optionLabel:"satuan",class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue","options"]))]),_:1}),s(_,{field:"harga",header:"Harga Satuan"},{body:d(({data:t,field:o})=>[g(h(t[o]?a.$h.formatNumber(t[o]):null),1)]),editor:d(({data:t,field:o})=>[B(s(x,{modelValue:t[o],"onUpdate:modelValue":r=>t[o]=r,class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue"]),[[E]])]),_:1}),s(_,{field:"total",header:"Jumlah"},{body:d(({data:t,field:o})=>[g(h(t[o]?a.$h.formatNumber(t[o]):null),1)]),_:1}),s(_,{header:"#",headerStyle:"width:5%;"},{body:d(({data:t})=>[s(k,{icon:"pi pi-trash",class:"p-button-rounded p-button-danger",onClick:o=>u.hapusBarisDetail(t)},null,8,["onClick"])]),_:1})]),_:1},8,["value","onCellEditComplete"]),s(b,{error:u.FormError.detail},null,8,["error"])]),pe,ge,i("div",_e,[i("div",ye,[be,i("div",fe,h(a.$h.formatNumber(u.subtotal)),1)])])]),ke,i("div",ve,[Ce,i("div",we,[i("div",Ve,[n.item.status!="C"?(y(),f(I,{key:0,loading:a.$isLoading.value,data:n.item,onClick:e[3]||(e[3]=t=>u.Save("D")),onClose:e[4]||(e[4]=t=>u.Save("C")),showClose:n.item.status=="D"},null,8,["loading","data","showClose"])):J("",!0)])])]),s(A,{visible:a.cancelDialog,"onUpdate:visible":e[7]||(e[7]=t=>a.cancelDialog=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:d(()=>[s(k,{label:"Close",icon:"pi pi-times",class:"p-button-text text-red-500",onClick:e[6]||(e[6]=t=>a.cancelDialog=!1)}),s(k,{label:"Submit",icon:"pi pi-check",class:"p-button-text",onClick:a.submitCancel},null,8,["onClick"])]),default:d(()=>[De,s(S,{class:"w-full",modelValue:n.item.alasan,"onUpdate:modelValue":e[5]||(e[5]=t=>n.item.alasan=t),rows:"5",cols:"30"},null,8,["modelValue"])]),_:1},8,["visible"])])])])}const Le=O(Q,[["render",Se]]);export{Le as default};
