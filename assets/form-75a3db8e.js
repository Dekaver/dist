import{A as O}from"./index-b9e295bc.js";import{a as k}from"./paymentap-dead24ec.js";import"./custom-zod-e9521e5d.js";import{M as G}from"./ModalJurnal-5f84a831.js";import{_ as Q,x as W,y as X,r as c,A as Z,o as d,c as f,b as a,d as o,l as y,t as p,e as g,k as b,n as A,m as T,q as L,B as x,f as D,C as $}from"./index-11eb6111.js";import{z as h}from"./index-0ec66d4d.js";const tt=h.object({number:h.string().nullish(),date:h.date(),id_supplier:h.number(),bank_account:h.number(),other_cost:h.number(),total:h.number().positive().gt(0),status:h.string(),description:h.string().max(255).nullish(),detail:h.array(h.object({ap_number:h.string().nullish(),discount:h.number().gte(0),discountpersen:h.number().gte(0),amount:h.number().positive().gt(0)})).min(1)}),et={components:{ModalJurnal:G},data(){return{akunStore:W(),settingStore:X(),item:{id:null,number:null,date:null,id_supplier:null,bank_account:null,other_cost:0,total:null,status:null,description:null,detail:[{ap_number:null,date:null,id_supplier:null,invoice_number:null,invoice_date:null,top:null,due_date:null,amount:null,discount:null,discountpersen:null}]},nullDetail:null,lAccApF:[],selectedAccApF:[],filteredAccApF:[],columns:[{field:"ap_number",header:"AP Number",editor:!0},{field:"invoice_number",header:"Invoice Number",editor:!1},{field:"date",header:"Date",type:"date",editor:!1},{field:"ap_amount",header:"Jumlah Hutang",type:"currency",class:"text-right",editor:!1},{field:"discountpersen",header:"Diskon %",type:"number",editor:!0},{field:"discount",header:"Diskon Rp",type:"currency",class:"text-right",editor:!0},{field:"amount",header:"Jumlah Dibayar",type:"currency",class:"text-right",editor:!0}],status:null,isClean:!0,isEdit:!1,closingDialog:!1,jurnalDialog:!1,showPersetujuanDialog:!1,splitButtonClossing:[{label:"Save Permanent",icon:"pi pi-refresh",command:()=>{this.closingDialog="true"}}]}},computed:{total(){return this.item.detail.reduce((e,t)=>e+parseFloat(t.amount||0),0)+parseFloat(this.item.other_cost||0,2)},FormItem(){return{...this.item,status:this.status,jurnal:this.jurnal,detail:this.item.detail.filter(e=>e.ap_number!=null)}},FormError(){var e,t;return this.isClean?{}:((t=(e=tt.safeParse(this.FormItem))==null?void 0:e.error)==null?void 0:t.format())||{}},canPersetujuan(){var n;const e=(n=this.item.persetujuan)==null?void 0:n.find(l=>l.id_pegawai==this.$auth.id&&l.tanggal_persetujuan==null),t=e?this.item.persetujuan.find(l=>l.urut<e.urut&&l.status===!0):null;return e&&(t||(e==null?void 0:e.urut)==1)},jurnal(){if(this.akunStore.count==0)return[];const e=[],t=this.item.detail.filter(l=>l.ap_number!=null).reduce((l,s)=>l+parseFloat(s.discount||0),0),n=this.item.detail.filter(l=>l.ap_number!=null).reduce((l,s)=>l+parseFloat(s.amount||0),0);if(n){const l=this.akunStore.getAkunById(215);e.push({id_account:l.id,account_name:l.name,account_code:l.code,is_debit:!0,amount:n+t})}if(this.item.other_cost){const l=this.akunStore.getAkunById(244);e.push({id_account:l.id,account_name:l.name,account_code:l.code,is_debit:!0,amount:this.item.other_cost})}if(t){const l=this.akunStore.getAkunById(246);e.push({id_account:l.id,account_name:l.name,account_code:l.code,is_debit:!1,amount:t})}if(this.total&&this.item.bank_account){const l=this.akunStore.getAkunById(this.item.bank_account);e.push({id_account:l.id,account_name:l.name,account_code:l.code,is_debit:!1,amount:this.total})}return e}},watch:{total(e){this.item.total=e}},methods:{async getData(){},async Save(e="D"){try{if(this.status=e,this.isClean=!1,this.$isLoading.value=!0,Object.keys(this.FormError).length>0)return;this.isEdit?await k.update(this.item.id,this.FormItem).then(t=>{this.item.status=t.data.data.status,this.item.persetujuan=t.data.data.persetujuan,this.$toast.add({severity:"success",summary:"Success",detail:t.data.message,life:3e3}),this.isClean=!0}):await k.store(this.FormItem).then(t=>{this.item.id=t.data.data.id,this.item.number=t.data.data.number,this.item.status=t.data.data.status,this.item.persetujuan=t.data.data.persetujuan,this.$toast.add({severity:"success",summary:"Success",detail:t.data.message,life:3e3}),this.isEdit=!0,setTimeout(()=>{this.$router.replace({name:"paymentap.edit",params:{id:this.item.id}})},1e3)})}catch(t){t instanceof O&&this.$toast.add({severity:"error",summary:"Failed",detail:t.response.data.message,life:3e3}),console.error(t)}finally{this.closingDialog=!1,this.$timeoutLoading()}},async submitPersetujuan(e=!1){const t={id:this.item.id,status:e,keterangan:this.item.keterangan};this.$isLoading.value=!0,await k.updatePersetujuan(t).then(n=>{this.item.status=n.data.data.update_status||this.item.status,this.item.persetujuan.forEach(l=>{l.urut==n.data.data.urut&&(l.tanggal_persetujuan=n.data.data.tanggal_persetujuan,l.status=n.data.data.status,l.keterangan=n.data.data.keterangan)}),this.$toast.add({severity:"success",summary:"Successful",detail:"Update persetujuan",life:3e3}),this.showPersetujuanDialog=!1}).catch(n=>{this.$toast.add({severity:"error",summary:"Error",detail:n,life:3e3})}).finally(()=>{this.$timeoutLoading()}),this.showPersetujuanDialog=!1},confirmApprove(){this.showPersetujuanDialog=!0,this.item.keterangan="",this.isApprove=!0},confirmReject(){this.showPersetujuanDialog=!0,this.item.keterangan="",this.isApprove=!1},removeDetail(e){this.item.detail.length!=1&&(this.item.detail=this.item.detail.filter(t=>t!==e))},async getPaymentAp(){await k.show(this.item.id).then(async e=>{this.item=e.data.data,this.item.other_cost=parseFloat(this.item.other_cost),this.item.date=this.$h.Date(this.item.date),e.data.data.detail.map((t,n)=>{this.item.detail[n].discount=parseFloat(t.discount),this.item.detail[n].discount=parseFloat(t.discount),this.item.detail[n].discountpersen=parseFloat(t.discount)*100/parseFloat(t.ap_amount),this.item.detail[n].ap_amount=parseFloat(t.ap_amount),this.item.detail[n].amount=parseFloat(t.amount)}),this.item.status=="D"&&(await k.indexBySupplier(this.item.id_supplier).then(t=>{this.lAccApF=t.data.data}).catch(t=>{this.$toast.add({severity:"error",summary:"Failed",detail:t.response.data.message,life:3e3})}),this.tambahDetail())}).catch(e=>{this.$toast.add({severity:"error",summary:"Failed",detail:e.response.data.message,life:3e3})})},onCellEditComplete(e){let{data:t,newValue:n,field:l}=e;switch(l){case"ap_number":if(typeof n=="string"||n==null){this.tambahDetail();return}t.amount=parseFloat(n.amount),t.invoice_number=n.invoice_number,t.date=n.invoice_date,t.discountpersen=0,t.discount=0,t.ap_amount=n.amount,t.ap_number=n.ap_number,this.tambahDetail();break;case"discountpersen":t[l]=n,t.discount=parseFloat(t.ap_amount)*parseFloat(n)/100,t.amount=parseFloat(t.ap_amount)-parseFloat(t.discount);break;case"discount":t[l]=n,t.discountpersen=parseFloat(n)*100/parseFloat(t.ap_amount),t.amount=parseFloat(t.ap_amount)-parseFloat(t.discount);break;case"amount":t[l]=n;break}},async selectSupplier(e){this.item.detail=[{...this.nullDetail}],await k.indexBySupplier(e.value.id).then(t=>{this.lAccApF=t.data.data,this.item.id_supplier=e.value.id,this.item.supplier=e.value.kontak,this.item.description=`Pembayaran AP ${e.value.kontak}`})},searchAccApF(e){setTimeout(()=>{this.filteredAccApF=e.query.trim().length?this.lAccApF.filter(t=>t.ap_number.toLowerCase().includes(e.query.toLowerCase())&&!this.item.detail.some(n=>n.ap_number==t.ap_number)):[...this.lAccApF]},250)},searchAllAccApF(){setTimeout(()=>{this.filteredAccApF=this.lAccApF.filter(e=>!this.item.detail.some(t=>t.ap_number==e.ap_number))},250)},tambahDetail(){this.item.detail.some(e=>e.ap_number==null)||this.item.detail.push({...this.nullDetail})}},mounted(){this.item.id=this.$route.params.id,this.isEdit=!!this.$route.params.id,this.$isLoading.value=!0,this.nullDetail={...this.item.detail[0]},this.getData().then(()=>{this.isEdit&&this.getPaymentAp(),this.item.date=new Date}).finally(()=>{this.$timeoutLoading()})}},at={class:"grid"},st={class:"col-12"},it={class:"card"},lt={class:"p-fluid formgrid grid"},nt={class:"field col-12 md:col-4"},ot={class:"field col-12 md:col-4"},rt=a("div",{class:"col-12"},null,-1),ut={class:"field col-12 md:col-4"},dt={class:"field col-12 md:col-4"},mt={class:"field col-12"},ct={class:"col-12 my-4"},pt={key:0},ht={key:1},_t={key:2,class:"text-right"},gt={key:3},ft=a("div",{class:"text-center"},"Empty",-1),bt={class:"grid col"},vt={class:"col-4 p-0"},yt=a("div",{class:"col-4 p-0"},null,-1),kt={class:"col-4 p-0 text-right text-green-500"},Dt={class:"col-4 p-0 font-bold"},At={class:"col-4 p-0"},Ft=a("div",{class:"grid"},null,-1),Ct=a("div",{class:"col-12 md:col-8"},null,-1),jt={class:"field col-12 md:col-4"},xt={class:"grid formdgrid py-3 justify-content-center align-items-center"},wt=a("div",{class:"col-6"},"Biaya Lain",-1),Vt={class:"col-6"},St={class:"grid py-3 justify-content-center align-items-center"},Et=a("div",{class:"col-12"},[a("hr")],-1),Pt=a("div",{class:"col-6"},"Total",-1),Ut={class:"col-6 text-right"},Bt=a("div",{class:"col-12"},null,-1),It={key:0,class:"p-datatable col-6"},Tt={class:"p-datatable-table p-datatable-striped"},Lt=a("thead",{class:"p-datatable-thead"},[a("tr",{role:"row"},[a("th",{colspan:"7",class:"text-left"},"Harus Disetujui Oleh:")]),a("tr",null,[a("th",null,"No"),a("th",null,"Nama"),a("th",null,"Jabatan"),a("th",null,"Tanggal"),a("th",null,"Status"),a("th",null,"Keterangan")])],-1),Nt={class:"p-datatable-tbody"},Mt={key:0},qt={key:1},Jt={key:2},Rt={class:"grid"},Kt={class:"col-6"},Yt={class:"flex flex-wrap gap-3 justify-content-start"},zt={class:"col-6"},Ht={class:"flex flex-wrap gap-3 justify-content-end"},Ot={class:"flex flex-column align-items-center justify-content-center"},Gt=a("i",{class:"pi pi-exclamation-triangle mr-3",style:{"font-size":"2rem"}},null,-1),Qt={key:0},Wt=a("div",{class:"flex align-items-center justify-content-center"},[a("i",{class:"pi pi-exclamation-triangle mr-3",style:{"font-size":"2rem"}}),a("span",null,"Masukkan Catatan")],-1);function Xt(e,t,n,l,s,r){var U,B,I;const N=c("Toast"),M=c("Tag"),F=c("Label"),w=c("InputText"),q=c("AutoCompleteKontak"),J=c("AutoCompleteAkun"),R=c("Calendar"),V=c("ErrorMsg"),S=c("Textarea"),K=c("AutoComplete"),C=c("InputNumber"),E=c("Column"),v=c("Button"),Y=c("DataTable"),z=c("SubmitButton"),P=c("Dialog"),H=c("ModalJurnal"),j=Z("select-all-text");return d(),f("div",at,[a("div",st,[a("div",it,[o(N),a("h5",null,[y(p(s.isEdit?"Ubah":"Tambah")+" Payment AP ",1),o(M,{style:{float:"right"},value:e.$h.getLabel(s.item.status),severity:e.$h.getLabel(s.item.status)},null,8,["value","severity"])]),a("div",lt,[a("div",nt,[o(F,{required:""},{default:g(()=>[y("Supplier")]),_:1}),s.item.status=="C"?(d(),b(w,{key:0,value:s.item.supplier,disabled:""},null,8,["value"])):(d(),b(q,{key:1,modelValue:s.item.id_supplier,"onUpdate:modelValue":t[0]||(t[0]=i=>s.item.id_supplier=i),label:"Supplier",onSelectItem:r.selectSupplier,error:r.FormError.id_supplier,"is-supplier":"","is-hutang":"",showLabel:!1},null,8,["modelValue","onSelectItem","error"]))]),a("div",ot,[o(J,{modelValue:s.item.bank_account,"onUpdate:modelValue":t[1]||(t[1]=i=>s.item.bank_account=i),label:"Kas/Bank",error:r.FormError.bank_account,cashable:""},null,8,["modelValue","error"])]),rt,a("div",ut,[o(F,{class:"tanggal",required:""},{default:g(()=>[y("Tanggal")]),_:1}),o(R,{modelValue:s.item.date,"onUpdate:modelValue":t[2]||(t[2]=i=>s.item.date=i),inputId:"tanggal",class:A(r.FormError.date&&"p-invalid"),maxDate:e.$h.today},null,8,["modelValue","class","maxDate"]),o(V,{error:r.FormError.date},null,8,["error"])]),a("div",dt,[o(F,{required:s.isEdit,for:"nomor"},{default:g(()=>[y("Nomor")]),_:1},8,["required"]),o(w,{modelValue:s.item.number,"onUpdate:modelValue":t[3]||(t[3]=i=>s.item.number=i),modelModifiers:{trim:!0},id:"nomor",readonly:"",class:A(r.FormError.number&&"p-invalid")},null,8,["modelValue","class"]),o(V,{error:r.FormError.number},null,8,["error"])]),a("div",mt,[o(F,{required:"",for:"keternagan"},{default:g(()=>[y("Keterangan")]),_:1}),o(S,{modelValue:s.item.description,"onUpdate:modelValue":t[4]||(t[4]=i=>s.item.description=i),modelModifiers:{trim:!0},id:"keternagan",class:A(r.FormError.description&&"p-invalid")},null,8,["modelValue","class"])]),a("div",ct,[o(Y,{filters:e.filters,"onUpdate:filters":t[5]||(t[5]=i=>e.filters=i),value:s.item.detail,compareSelectionBy:"deepEquals",editMode:"cell",onCellEditComplete:r.onCellEditComplete,tableClass:"editable-cells-table p-datatable-small",tableStyle:"table-layout: auto;"},{default:g(()=>[(d(!0),f(T,null,L(s.columns,i=>(d(),b(E,{key:i.field,field:i.field,header:i.header},$({body:g(({data:u,field:m})=>[i.type=="number"?(d(),f("div",pt,p(e.$h.formatNumber(u[m])),1)):i.type=="date"?(d(),f("div",ht,p(e.$h.formatDate(u[m])),1)):i.type=="currency"?(d(),f("div",_t,p(e.$h.formatNumber(u[m])),1)):(d(),f("div",gt,p(u[m]),1))]),empty:g(()=>[ft]),_:2},[s.item.status!="C"&&i.editor?{name:"editor",fn:g(({data:u,field:m})=>[m=="ap_number"?(d(),b(K,{key:0,modelValue:u[m],"onUpdate:modelValue":_=>u[m]=_,suggestions:s.filteredAccApF,optionLabel:"ap_number",onComplete:r.searchAccApF,onDropdownClick:r.searchAllAccApF,dropdown:"",class:"min-w-max",forceSelection:""},{option:g(({option:_})=>[a("div",bt,[a("div",vt,p(e.$h.formatDate(_.invoice_date)),1),yt,a("div",kt,p(e.$h.formatCurrency(_.sisa)),1),a("div",Dt,p(_.ap_number),1),a("div",At,p(_.invoice_number),1),a("div",{class:A(["col-4 p-0 font-bold text-right",_.umur_overdue<0?"text-green-500":"text-red-500"])},p(_.umur_overdue)+" hari lagi ",3)]),Ft]),_:2},1032,["modelValue","onUpdate:modelValue","suggestions","onComplete","onDropdownClick"])):m=="amount"?x((d(),b(C,{key:1,modelValue:u[m],"onUpdate:modelValue":_=>u[m]=_,inputId:"minmaxfraction","input-class":"text-right",class:"min-w-max",minFractionDigits:1,maxFractionDigits:2,min:0,max:u.ap_amount-u.discount},null,8,["modelValue","onUpdate:modelValue","max"])),[[j]]):m=="discount"?x((d(),b(C,{key:2,modelValue:u[m],"onUpdate:modelValue":_=>u[m]=_,inputId:"minmaxfraction","input-class":"text-right",class:"min-w-max",minFractionDigits:1,maxFractionDigits:2,min:0,max:u.ap_amount},null,8,["modelValue","onUpdate:modelValue","max"])),[[j]]):m=="discountpersen"?x((d(),b(C,{key:3,modelValue:u[m],"onUpdate:modelValue":_=>u[m]=_,"input-class":"text-right",class:"min-w-max",inputId:"minmaxfraction",minFractionDigits:1,maxFractionDigits:2,min:0,max:100},null,8,["modelValue","onUpdate:modelValue"])),[[j]]):D("",!0)]),key:"0"}:void 0]),1032,["field","header"]))),128)),o(E,{header:"#",headerStyle:"width:5%;"},{body:g(({data:i})=>[o(v,{icon:"pi pi-trash",class:"p-button-rounded p-button-danger",onClick:u=>r.removeDetail(i)},null,8,["onClick"])]),_:1})]),_:1},8,["filters","value","onCellEditComplete"])]),Ct,a("div",jt,[a("div",xt,[wt,a("div",Vt,[x(o(C,{modelValue:s.item.other_cost,"onUpdate:modelValue":t[6]||(t[6]=i=>s.item.other_cost=i),inputId:"minmaxfraction",minFractionDigits:1,maxFractionDigits:2,min:0,class:"w-full",inputClass:"text-right"},null,8,["modelValue"]),[[j]])])]),a("div",St,[Et,Pt,a("div",Ut,p(e.$h.formatNumber(r.total)),1)])]),Bt]),((U=s.item.persetujuan)==null?void 0:U.length)>0&&!this.$route.query.revisi?(d(),f("div",It,[a("table",Tt,[Lt,a("tbody",Nt,[(d(!0),f(T,null,L(s.item.persetujuan,(i,u)=>(d(),f("tr",{key:u},[a("td",null,p(u+1),1),a("td",null,p(i.nama),1),a("td",null,p(i.jabatan),1),a("td",null,p(e.$h.formatDate(i.tanggal_persetujuan,"DD-MM-YYYY HH:mm:ss")),1),i.tanggal_persetujuan!=null&&!i.status?(d(),f("td",Mt,"Reject")):i.tanggal_persetujuan!=null&&i.status?(d(),f("td",qt,"Approve")):(d(),f("td",Jt,"Menunggu Persetujuan")),a("td",null,p(i.keterangan),1)]))),128))])])])):D("",!0),a("div",Rt,[a("div",Kt,[a("div",Yt,[o(v,{style:{float:"right"},label:"Jurnal",class:A(["p-button mx-2",{"p-button-block":s.jurnalDialog,"p-button-outlined":!s.jurnalDialog}]),onClick:t[7]||(t[7]=i=>s.jurnalDialog=!s.jurnalDialog)},null,8,["class"])])]),a("div",zt,[a("div",Ht,[!r.canPersetujuan&&!((I=(B=s.item.persetujuan)==null?void 0:B[0])!=null&&I.tanggal_persetujuan)&&s.item.status!="C"?(d(),b(z,{key:0,loading:e.$isLoading.value,data:s.item,onClick:t[8]||(t[8]=i=>{var u;return r.Save((u=s.settingStore.pembelian.persetujuan.payment)!=null&&u.persetujuan1?"S":"C")}),onDraft:t[9]||(t[9]=i=>r.Save("D")),showDraft:s.item.status==null||s.item.status=="D"},null,8,["loading","data","showDraft"])):D("",!0),s.item.status=="S"&&r.canPersetujuan?(d(),b(v,{key:1,label:"Reject",severity:"danger",iconPos:"right",icon:"pi pi-times",onClick:r.confirmReject,class:"mx-2"},null,8,["onClick"])):D("",!0),s.item.status=="S"&&r.canPersetujuan?(d(),b(v,{key:2,label:"Approve",severity:"success",iconPos:"right",icon:"pi pi-check",onClick:r.confirmApprove},null,8,["onClick"])):D("",!0)])])]),o(P,{visible:s.closingDialog,"onUpdate:visible":t[12]||(t[12]=i=>s.closingDialog=i),style:{width:"450px"},header:"Confirm",modal:!0},{footer:g(()=>[o(v,{label:"No",icon:"pi pi-times",class:"p-button-text",onClick:t[10]||(t[10]=i=>s.closingDialog=!1)}),o(v,{label:"Yes",icon:"pi pi-check",class:"p-button-text",onClick:t[11]||(t[11]=i=>r.Save("C"))})]),default:g(()=>[a("div",Ot,[Gt,s.item?(d(),f("span",Qt,[y("Are you sure you want to close this "),a("b",null,p(s.item.number),1),y("?")])):D("",!0)])]),_:1},8,["visible"]),o(P,{visible:s.showPersetujuanDialog,"onUpdate:visible":t[16]||(t[16]=i=>s.showPersetujuanDialog=i),style:{width:"450px"},header:"Confirm",modal:!0},{footer:g(()=>[o(v,{label:"Close",icon:"pi pi-times",class:"p-button-text text-red-500",onClick:t[14]||(t[14]=i=>s.showPersetujuanDialog=!1)}),o(v,{label:e.isApprove?"Approve":"Reject",icon:"pi pi-check",class:"p-button-text",onClick:t[15]||(t[15]=i=>r.submitPersetujuan(e.isApprove))},null,8,["label"])]),default:g(()=>[Wt,o(S,{class:"w-full",modelValue:s.item.keterangan,"onUpdate:modelValue":t[13]||(t[13]=i=>s.item.keterangan=i),rows:"5",cols:"30",placeholder:"Optional"},null,8,["modelValue"])]),_:1},8,["visible"]),o(H,{visible:s.jurnalDialog,"onUpdate:visible":t[17]||(t[17]=i=>s.jurnalDialog=i),value:r.jurnal,"onUpdate:value":t[18]||(t[18]=i=>r.jurnal=i)},null,8,["visible","value"])])])])}const ie=Q(et,[["render",Xt]]);export{ie as default};
