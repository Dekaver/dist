import{a as M}from"./kategoriproduk-68d52205.js";import{a as F}from"./api-ff803cba.js";import{_ as U,o as m,c as v,b as l,w as j,t as f,f as g,m as T,r as d,A as z,d as n,l as P,k as D,e as k,B as x}from"./index-11eb6111.js";import"./custom-zod-e9521e5d.js";/* empty css                             */import{x as h}from"./xlsx.min-b21a3818.js";import{A as R}from"./index-b9e295bc.js";import{z as r}from"./index-0ec66d4d.js";const X={name:"UploadFile",props:{singleFile:{type:Boolean,default:!1},idOpname:{type:Number,default:null},maxFiles:{type:Number,default:1/0}},data(){return{file:null,message:null}},computed:{filename:function(){return this.file!=null?this.file.name:null}},methods:{openFileExplorer(){this.$refs.fileInput.click()},handleFileDrop(e){e.preventDefault(),e.dataTransfer.files.length>1&&this.displayError("Only one file can uploaded"),this.validateFile(e.dataTransfer.files[0])&&(this.file=e.dataTransfer.files[0])},inputFile(e){e.preventDefault(),e.target.files.length>1&&this.displayError("Only one file can uploaded"),this.validateFile(e.target.files[0])&&(this.file=e.target.files[0])},validateFile(e){if(e===void 0)return this.file=null,!1;const t=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],a=5*1024*1024;return t.includes(e.type)?e.size>a?(this.displayError(`File size exceeds 5MB: ${e.size}`),!1):!0:(this.displayError(`File type not allowed: ${e.type}`),!1)},displayError(e){this.$emit("error",e)},async submit(){this.uploadFile(this.file)},uploadFile(e){const t=new FormData;t.append("file",e),F.uploadXlsx(this.idOpname,t).then(()=>{this.$toast.add({severity:"success",summary:"Success",detail:"Uploaded Stok Opname",life:3e3})}).catch(a=>{console.error("Error uploading image:",a),this.$toast.add({severity:"error",summary:"Failed",detail:"Create Stok Opname",life:3e3})})}},mounted(){}},J=l("i",{class:"pi pi-upload text-5xl"},null,-1),Q=l("p",null,"Drag and drop files here or click to browse.",-1),Y={key:0,class:""};function G(e,t,a,u,s,i){return m(),v(T,null,[l("div",{onClick:t[1]||(t[1]=(...c)=>i.openFileExplorer&&i.openFileExplorer(...c)),class:"flex flex-column align-items-center justify-content-center gap-2 border-2 border-dashed p-4",onDragover:t[2]||(t[2]=j(()=>{},["prevent"])),onDrop:t[3]||(t[3]=(...c)=>i.handleFileDrop&&i.handleFileDrop(...c))},[J,Q,l("input",{type:"file",style:{display:"none"},ref:"fileInput",onChange:t[0]||(t[0]=(...c)=>i.inputFile&&i.inputFile(...c))},null,544)],32),i.filename?(m(),v("div",Y,"File :"+f(i.filename),1)):g("",!0)],64)}const H=U(X,[["render",G]]),Z=r.object({tanggal:r.date(),nomor:r.string().nullish(),id_gudang:r.number().positive(),id_account:r.number().positive(),id_kategori_barang:r.number().nullish(),detail:r.array(r.object({urut:r.number().positive(),kode_barang:r.string(),nama_barang:r.string(),qty:r.number().gte(0),qty_stok:r.number().gte(0),selisih:r.number(),notes:r.string().nullish()})).superRefine((e,t)=>{for(let a=0;a<e.length;a++){const u=e[a];u.is_selected&&u.qty-u.qty_stok!=0&&(u.notes==null||u.notes=="")&&t.addIssue({path:[a,"notes"],code:r.ZodIssueCode.custom,inclusive:!0,message:"Harus Ada Keterangan, karena Selisih"})}})}),W={data(){return{item:{id:null,nomor:null,tanggal:null,keterangan:null,status:null,detail:[{id:null,urut:null,id_barang:null,qty:1,notes:null,satuan:null}]},fileUploadDialog:!1,uploadErrorMessage:null,columns:[{field:"no",header:"No"},{field:"kode_barang",header:"Kode Barang"},{field:"nama_barang",header:"Nama Barang"},{field:"qty_stok",header:"QTY"},{field:"qty",header:"QTY Fisik"},{field:"selisih",header:"Selisih"},{field:"satuan",header:"Satuan"},{field:"notes",header:"Keterangan"}],printColumns:[{field:"no",header:"No"},{field:"kode_barang",header:"Kode Barang"},{field:"nama_barang",header:"Nama Barang"},{field:"qty",header:"QTY Fisik"},{field:"satuan",header:"Satuan"},{field:"remark",header:"Keterangan"}],isEdit:!1,isClean:!0}},components:{UploadFile:H},computed:{FormError(){var e,t;return this.isClean?{}:((t=(e=Z.safeParse(this.item))==null?void 0:e.error)==null?void 0:t.format())||{}}},mounted(){this.item.id=this.$route.params.id,this.isEdit=!!this.$route.params.id,this.$isLoading.value=!0,this.getData().then(()=>{this.isEdit?this.getStokOpname():(this.tanggal=new Date,this.item.tanggal=this.tanggal)}).finally(()=>{this.$timeoutLoading()})},methods:{async getData(){await M.index().then(e=>{this.lProduk=e.data.data}).catch(()=>{this.$toast.add({severity:"error",summary:"Failed",detail:"Load Barang",life:3e3})})},onCellEditComplete(e){let{data:t,newValue:a,field:u}=e;switch(u){case"qty":t.qty=a,t.selisih=t.qty-t.qty_stok;break}t[u]=a},async getStokOpname(){await F.show(this.item.id).then(e=>{this.item={...e.data.data,detail:e.data.data.detail.map(t=>({...t,qty:parseFloat(t.qty),qty_stok:parseFloat(t.qty_stok),selisih:parseFloat(t.selisih)}))},this.item.tanggal=new Date(e.data.data.tanggal)})},async Save(e="D"){const t=this.item.status;try{if(this.$isLoading.value=!0,this.isClean=!1,this.item.status=e,Object.keys(this.FormError).length>0){this.item.status=t,this.$timeoutLoading();return}await F.update(this.item.id,this.item).then(a=>{this.$toast.add({severity:"success",summary:"Successful",detail:a.data.message,life:3e3})})}catch(a){this.item.status=t,a instanceof R&&this.$toast.add({severity:"error",summary:"Failed!",detail:a.response.data.message,life:3e3})}finally{this.$timeoutLoading()}},saveUploaded(){this.$refs.uploadXlsx.submit().finally(()=>{this.getData().finally(()=>{this.getStokOpname()})}),this.fileUploadDialog=!1},handleUploadError(e){this.uploadErrorMessage=e},getColor(e){return e>0?"color:blue":e<0?"color:red":"color:black"},getStatusLabel(e){switch(e){case"D":return"Draft";case"A":return"Approve";case"U":return"Upload";case"X":return"Cancel";default:return"-"}},submitApprove(){this.Save("A")},async selectDate(e){this.item.tanggal=new Date(e)},async selectDateDN(e){this.item.tgl_dn=new Date(e)},filters:{pretty:function(e){return JSON.stringify(JSON.parse(e),null,2)}},async tableToExcel(){const e=document.getElementById("detail"),t=h.utils.table_to_sheet(e),a=h.utils.sheet_to_json(t),s=[Object.keys(a[0]).filter(_=>_!="Kuantitas"&&_!="Selisih"),...a.map(({Kuantitas:_,Selisih:C,...S})=>Object.values(S))],i=[["STOK OPNAME "],[],["Nomor",":",this.item.nomor],["tanggal",":",this.$h.formatDate(this.item.tanggal)],["Status",":",this.getStatusLabel(this.item.status)],["Keterangan",":",this.item.keterangan],[]],c=h.utils.book_new(),E=h.utils.aoa_to_sheet([...i,...s]);h.utils.book_append_sheet(c,E,"Sheet 1"),h.writeFile(c,`Stok Opname_${new Date().getTime()}.xlsx`)},async tableReportToExcel(){const e=document.getElementById("report"),t=h.utils.book_new(),a=h.utils.table_to_sheet(e);var u=[{wch:5},{wch:15},{wch:30},{wch:10},{wch:10},{wch:15}];a["!cols"]=u,h.utils.book_append_sheet(t,a,"SheetJS"),h.writeFile(t,`Stok Opname_${new Date().getTime()}.xlsx`)}}},$={class:"grid",id:"report"},ee={class:"col-12"},te={class:"card"},le={key:0,class:"p-fluid formgrid grid mt-3"},se={class:"table col-8"},ae={key:0},ie=l("td",{colspan:"8"},"PT. SARANA BERKAT SESAMI",-1),oe=[ie],ne={key:1},re=l("td",{colspan:"8"},"STOK ONAME",-1),de=[re],ue=l("td",null,"Nomor",-1),me=l("td",null,":",-1),ce=l("td",null,"Tgl.Dibuat",-1),pe=l("td",null,":",-1),he=l("td",null,"tanggal",-1),fe=l("td",null,":",-1),_e=l("td",null,"Tgl.Upload",-1),ge=l("td",null,":",-1),be=l("td",null,"Status",-1),ye=l("td",null,":",-1),ke=l("td",null,"Tgl.Approve",-1),ve=l("td",null,":",-1),De=l("td",null,"Keterangan",-1),Ee=l("td",null,":",-1),Se=l("tr",null,[l("td",{colspan:"8"})],-1),Fe={class:"col-2"},Ce={class:"col-2"},we={class:"p-fluid formgrid grid"},xe={class:"field col-12 md:col-3"},Ue={class:"p-fluid formgrid grid mt-3"},Te=l("div",{class:"col-12"},null,-1),Ae={class:"col-12 mb-4"},Oe={class:"grid justify-content-between"},Ne={class:"col-fixed"},Ve={class:"col-fixed"},Be={class:"formgrid grid"},qe={class:"field col-12 d-flex justifiy-content-center align-items-end"},Ke={key:0,class:"text-red-500"};function Ie(e,t,a,u,s,i){const c=d("Toast"),E=d("Tag"),_=d("Button"),C=d("AutoCompleteGudang"),S=d("AutoCompleteAkun"),A=d("Checkbox"),b=d("Column"),O=d("InputNumber"),N=d("ErrorMsg"),V=d("InputText"),B=d("DataTable"),q=d("router-link"),K=d("SubmitButton"),I=d("UploadFile"),L=d("Dialog"),w=z("select-all-text");return m(),v(T,null,[n(c),l("div",$,[l("div",ee,[l("div",te,[l("h5",null,[P(" STOK OPNAME "),n(E,{style:{float:"right"},value:e.$h.getLabel(s.item.status),severity:e.$h.getLabel(s.item.status)},null,8,["value","severity"])]),s.item.status!=null?(m(),v("div",le,[l("table",se,[l("tbody",null,[s.item.status=="A"?(m(),v("tr",ae,oe)):g("",!0),s.item.status=="A"?(m(),v("tr",ne,de)):g("",!0),l("tr",null,[ue,me,l("td",null,f(s.item.nomor),1),ce,pe,l("td",null,f(e.$h.formatDate(s.item.created_at)),1)]),l("tr",null,[he,fe,l("td",null,f(e.$h.formatDate(s.item.tanggal)),1),_e,ge,l("td",null,f(e.$h.formatDate(s.item.uploaded_at)),1)]),l("tr",null,[be,ye,l("td",null,f(i.getStatusLabel(s.item.status)),1),ke,ve,l("td",null,f(e.$h.formatDate(s.item.approved_at)),1)]),l("tr",null,[De,Ee,l("td",null,f(s.item.keterangan),1)]),Se])]),l("div",Fe,[s.item.isupload==!0?(m(),D(_,{key:0,class:"ml-3",label:"Form Stok Opname",icon:"pi pi-download",size:"medium",iconPos:"left",onClick:i.tableToExcel},null,8,["onClick"])):g("",!0),s.item.isupload==!1?(m(),D(_,{key:1,class:"ml-3",label:"Export Report",icon:"pi pi-download",size:"medium",iconPos:"left",onClick:i.tableReportToExcel},null,8,["onClick"])):g("",!0)]),l("div",Ce,[s.item.isupload==!0?(m(),D(_,{key:0,class:"ml-3",label:"Upload Stok Opname",icon:"pi pi-upload",size:"medium",iconPos:"left",onClick:t[0]||(t[0]=o=>s.fileUploadDialog=!0)})):g("",!0)])])):g("",!0),l("div",we,[n(C,{modelValue:s.item.id_gudang,"onUpdate:modelValue":t[1]||(t[1]=o=>s.item.id_gudang=o)},null,8,["modelValue"]),l("div",xe,[n(S,{modelValue:s.item.id_account,"onUpdate:modelValue":t[2]||(t[2]=o=>s.item.id_account=o),head:1,level:4,error:i.FormError.id_account},null,8,["modelValue","error"])])]),l("div",Ue,[Te,l("div",Ae,[n(B,{value:s.item.detail,id:"detail",class:"p-dattable-sm",tableStyle:"min-width: 50%;",editMode:"cell",onCellEditComplete:i.onCellEditComplete,tableClass:"editable-cells-table"},{default:k(()=>[n(b,{field:"is_selected",header:"No"},{body:k(({data:o,field:p})=>[n(A,{modelValue:o[p],"onUpdate:modelValue":y=>o[p]=y,binary:!0},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),n(b,{field:"kode_barang",header:"Kode Barang"}),n(b,{field:"nama_barang",header:"Nama Barang"}),n(b,{field:"qty_stok",header:"Kuantitas"}),n(b,{field:"qty",header:"Kuantitas Fisik"},{editor:k(({data:o,field:p})=>[x(n(O,{modelValue:o[p],"onUpdate:modelValue":y=>o[p]=y,min:0,minFractionDigits:1,disabled:!o.is_selected},null,8,["modelValue","onUpdate:modelValue","disabled"]),[[w]])]),_:1}),n(b,{field:"selisih",header:"Selisih"}),n(b,{field:"satuan",header:"Satuan"}),n(b,{field:"notes",header:"Keterangan"},{body:k(({data:o,field:p,index:y})=>[l("div",null,f(o[p]),1),n(N,{error:i.FormError.detail&&i.FormError.detail[y]&&i.FormError.detail[y].notes},null,8,["error"])]),editor:k(({data:o,field:p})=>[x(n(V,{modelValue:o[p],"onUpdate:modelValue":y=>o[p]=y,disabled:!o.is_selected},null,8,["modelValue","onUpdate:modelValue","disabled"]),[[w]])]),_:1})]),_:1},8,["value","onCellEditComplete"])])]),l("div",Oe,[l("div",Ne,[n(q,{to:"/stok-opname"})]),l("div",Ve,[s.item.status!="C"?(m(),D(K,{key:0,loading:e.$isLoading.value,data:s.item,onClick:t[3]||(t[3]=o=>i.Save("D")),onClose:t[4]||(t[4]=o=>i.Save("C")),showClose:s.item.status=="D"},null,8,["loading","data","showClose"])):g("",!0)])]),n(L,{visible:s.fileUploadDialog,"onUpdate:visible":t[6]||(t[6]=o=>s.fileUploadDialog=o),style:{width:"450px"},header:"Form Upload Stok Opname",modal:!0,class:"p-fluid"},{footer:k(()=>[n(_,{label:"Cancel",icon:"pi pi-times",class:"p-button-text",onClick:t[5]||(t[5]=o=>s.fileUploadDialog=!1)}),n(_,{label:"Save",icon:"pi pi-check",class:"p-button-text",onClick:i.saveUploaded,loading:e.$isLoading.value,disabled:e.$isLoading.value},null,8,["onClick","loading","disabled"])]),default:k(()=>[l("div",Be,[l("div",qe,[n(I,{onImagesUploaded:e.handleImagesUploaded,ref:"uploadXlsx","error-message":s.uploadErrorMessage,onError:i.handleUploadError,"id-opname":this.item.id},null,8,["onImagesUploaded","error-message","onError","id-opname"]),s.uploadErrorMessage?(m(),v("div",Ke,f(s.uploadErrorMessage),1)):g("",!0)])])]),_:1},8,["visible"])])])])],64)}const Qe=U(W,[["render",Ie]]);export{Qe as default};
