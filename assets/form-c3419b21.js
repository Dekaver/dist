import{a as K}from"./options-b2eb7ae6.js";import{a as W}from"./satuan-84ad7de8.js";import{a as U}from"./produk-90d88791.js";import{a as Q}from"./api-646607e4.js";import{a as x}from"./api-b68fe7dd.js";import{_ as X,j as Z,y as $,r as _,A as ee,o as u,c as g,b as a,d as n,l as f,t as c,e as p,n as P,f as y,B as V,m as B,q as A,k as v,C as te}from"./index-11eb6111.js";import"./custom-zod-e9521e5d.js";import{A as ae}from"./index-b9e295bc.js";import{z as o}from"./index-0ec66d4d.js";const F=o.object({nomor:o.string().nullish(),tanggal:o.date(),id_supplier:o.number(),id_gudang:o.number(),referensi:o.string().min(1,{message:"Nomor DN harus diisi"}),id_po:o.number({invalid_type_error:"Nomor PO harus diisi"}),tanggal_referensi:o.date()}),O=o.object({id:o.number(),urut:o.number(),id_po:o.number(),urut_po:o.number(),id_barang:o.number().nullish(),nama_barang:o.string().min(0).max(255),note:o.string().min(0).max(200).nullish(),diorder:o.number().min(1),diambil:o.number()}),se=F.extend({status:o.literal("D"),detail:o.array(O.extend({diambil:o.number().gte(0)})).min(1,"Setidaknya harus ada 1 barang yg diterima")}),ie=F.extend({status:o.literal("S"),detail:o.array(O.extend({diambil:o.number().gt(0)})).min(1,"Setidaknya harus ada 1 barang yg diterima")}),re=F.extend({status:o.literal("C"),detail:o.array(O.extend({diambil:o.number().gt(0)})).min(1,"Setidaknya harus ada 1 barang yg diterima")}),le=o.discriminatedUnion("status",[se,ie,re]),ne={data(){return{gudangStore:Z(),settingStore:$(),item:{id:null,nomor:null,tanggal:null,id_supplier:null,supplier:null,id_gudang:null,referensi:null,keterangan:null,alamat:null,id_po:null,tanggal_referensi:null,status:null,detail:[{id:null,urut:null,id_barang:null,diorder:0,diambil:0,sisa:0,batch:null,satuan:null}]},lPurchaseOrder:[],filteredPurchaseOrder:[],selectedPurchaseOrder:null,lSatuan:null,optionSatuan:[],columns:[{field:"nama_barang",header:"Produk/Jasa",width:"width:max-content",class:"left"},{field:"diorder",header:"Dipesan",width:"width:auto",class:"left",type:"number"},{field:"sisa",header:"Sisa",width:"width:auto",class:"left",type:"number"},{field:"diambil",header:"Diterima",width:"width:auto",class:"left",type:"number",editor:!0},{field:"selectedSatuan",header:"Satuan",width:"width:10%",class:"left",editor:!0},{field:"note",header:"Keterangan",width:"width:10%",class:"left",editor:!0}],filters:{},closingDialog:!1,status:null,isClean:!0,isEdit:!1,showPersetujuanDialog:!1}},mounted(){this.item.id=this.$route.params.id,this.isEdit=!!this.$route.params.id,this.$isLoading.value=!0,this.getData().then(()=>{this.isEdit?this.getPenerimaanBarang():(this.item.tanggal=new Date,this.item.tanggal_referensi=new Date)}).finally(()=>{this.$timeoutLoading()})},computed:{FormError(){var i,e;return this.isClean?{}:((e=(i=le.safeParse(this.FormItem))==null?void 0:i.error)==null?void 0:e.format())||{}},FormItem(){return this.status=="D"?{...this.item,status:this.status}:{...this.item,status:this.status,detail:this.item.detail.filter(i=>parseInt(i.diambil)>0)}},canPersetujuan(){var r;const i=(r=this.item.persetujuan)==null?void 0:r.find(l=>l.id_pegawai==this.$auth.id&&l.tanggal_persetujuan==null),e=i?this.item.persetujuan.find(l=>l.urut<i.urut&&l.status===!0):null;return i&&(e||(i==null?void 0:i.urut)==1)}},methods:{onCellEditComplete(i){let{data:e,newValue:r,field:l}=i;switch(l){case"selectedSatuan":if(!r)return;e[l]=r,e.id_satuan=r.id,e.satuan=r.satuan;break;default:e[l]=r;break}},async getPenerimaanBarang(){await x.show(this.item.id).then(async i=>{this.item=i.data.data,this.status=i.data.data.status,this.selectedPurchaseOrder={id:this.item.id_po,nomor:this.item.nomor_po},this.item.tanggal=new Date(this.item.tanggal),this.item.tanggal_referensi=new Date(this.item.tanggal_referensi);const e=await Promise.all(i.data.data.detail.filter(r=>parseInt(r.sisa)>0).map(async r=>{if(r.id_barang!=null){const l=await U.getWithOptionSatuan(r.id_barang);return r.option_satuan=l.data.data.option_satuan,r.selectedSatuan=l.data.data.option_satuan.find(s=>s.id==r.id_satuan),{...r,diambil:parseFloat(r.diambil),diorder:parseFloat(r.diorder),sisa:parseFloat(r.sisa)}}else return{...r,diambil:parseFloat(r.diambil),diorder:parseFloat(r.diorder),sisa:parseFloat(r.sisa),option_satuan:[]}}));this.item.detail=e}).catch(i=>{this.$toast.add({severity:"error",summary:"Failed",detail:"Load data PB Detail",life:3e3})})},async getData(){await K.getPoOption("O,P","pb").then(i=>{this.lPurchaseOrder=i.data.data}).catch(()=>{this.$toast.add({severity:"error",summary:"Failed",detail:"Load data PO",life:3e3})}),await W.index().then(i=>{this.lSatuan=i.data.data}).catch(()=>{this.$toast.add({severity:"error",summary:"Failed",detail:"Load data Satuan Barang",life:3e3})})},searchPurchaseOrder(i){setTimeout(()=>{this.filteredPurchaseOrder=i.query.trim().length?this.lPurchaseOrder.filter(e=>e.nomor.toLowerCase().includes(i.query.toLowerCase())):[...this.lPurchaseOrder]},250)},async selectPurchaseOrder(i){this.selectedPurchaseOrder=i.value,await Q.show(this.selectedPurchaseOrder.id).then(async e=>{this.item.id_po=this.selectedPurchaseOrder.id,this.item.id_gudang=this.selectedPurchaseOrder.id_gudang,this.item.gudang=this.selectedPurchaseOrder.gudang,this.item.id_supplier=this.selectedPurchaseOrder.id_supplier,this.item.supplier=this.selectedPurchaseOrder.supplier;const r=await Promise.all(e.data.data.detail.filter(l=>parseInt(l.sisa)>0).map(async l=>{if(l.id_barang!=null){const s=await U.getWithOptionSatuan(l.id_barang);return l.option_satuan=s.data.data.option_satuan,l.selectedSatuan=s.data.data.option_satuan.find(d=>d.id==l.id_satuan),{...l,id_po:l.id,urut_po:l.urut,diorder:parseFloat(l.qty),diambil:0}}else return{...l,id_po:l.id,urut_po:l.urut,diorder:parseFloat(l.qty),diambil:0,option_satuan:[]}}));this.item.detail=r})},async Save(i="D"){this.$isLoading.value=!0;try{if(this.status=i,this.isClean=!1,Object.keys(this.FormError).length>0){this.$timeoutLoading();return}this.isEdit?await x.update(this.item.id,this.FormItem).then(e=>{this.item.status=e.data.data.status,this.item.persetujuan=e.data.data.persetujuan||[],this.$toast.add({severity:"success",summary:"Successful",detail:e.data.message,life:3e3})}):await x.store(this.FormItem).then(e=>{this.item.id=e.data.data.id,this.item.nomor=e.data.data.nomor,this.item.status=e.data.data.status,this.item.persetujuan=e.data.data.persetujuan||[],this.$toast.add({severity:"success",summary:"Successful",detail:"Created Penerimaan Barang",life:3e3}),setTimeout(()=>{this.$router.replace({name:"penerimaanbarang.edit",params:{id:this.item.id}})},1e3),this.isEdit=!0});return}catch(e){e instanceof ae&&this.$toast.add({severity:"error",summary:"Failed",detail:e.response.data.message,life:3e3})}finally{this.$timeoutLoading(),this.closingDialog=!1}},confirmApprove(){this.showPersetujuanDialog=!0,this.item.keterangan="",this.isApprove=!0},confirmReject(){this.showPersetujuanDialog=!0,this.item.keterangan="",this.isApprove=!1},async submitPersetujuan(i=!1){const e={id:this.item.id,status:i,keterangan:this.item.keterangan};this.$isLoading.value=!0,await x.updatePersetujuan(e).then(r=>{this.item.status=r.data.data.status_pp?r.data.data.status_pp:this.item.status,this.item.persetujuan.forEach(l=>{l.urut==r.data.data.urut&&(l.tanggal_persetujuan=r.data.data.tanggal_persetujuan,l.status=r.data.data.status,l.keterangan=r.data.data.keterangan)}),this.$toast.add({severity:"success",summary:"Successful",detail:"Update persetujuan",life:3e3}),this.showPersetujuanDialog=!1}).catch(r=>{this.$toast.add({severity:"error",summary:"Error",detail:r,life:3e3})}).finally(()=>{this.$timeoutLoading(),this.showPersetujuanDialog=!1}),this.showPersetujuanDialog=!1}},filters:{pretty:function(i){return JSON.stringify(JSON.parse(i),null,2)}}},oe={class:"grid"},de={class:"col-12"},ue={class:"card"},me=a("p",null,null,-1),ce={class:"p-fluid formgrid grid"},he={class:"field col-12 md:col-3"},pe={class:"grid col"},ge={class:"col-6 p-0 text-green-500"},_e={class:"col-6 p-0"},fe={class:"col-6 p-0 text-green-600 font-bold"},be={class:"col-6 p-0 font-bold"},ye={class:"field col-12 sm:col-6 md:col-4"},ve={key:0,class:"field col-12 sm:col-6 md:col-4 lg:col-3 xl:col-2"},we=a("div",{class:"col-12"},null,-1),ke={class:"field col-12 md:col-3"},Se={class:"field col-12 sm:col-6 md:col-4 lg:col-3"},De={class:"field col-12 sm:col-6 md:col-4 lg:col-3 xl:col-3"},Pe={class:"field col-12 md:col-3"},xe={class:"col-12 mb-4"},Ce={class:"flex align-items-center gap-2"},je={class:"capitalize"},Ve={key:0},Fe={key:1},Oe={key:2},Ee={key:0,class:"flex flex-column"},Le={class:"text-green-500"},Ie={key:1},Ne={key:3},Te={key:0,class:"p-datatable col-6"},Ue={class:"p-datatable-table p-datatable-striped"},Be=a("thead",{class:"p-datatable-thead"},[a("tr",{role:"row"},[a("th",{colspan:"7",class:"text-left"},"Harus Disetujui Oleh:")]),a("tr",null,[a("th",null,"No"),a("th",null,"Nama"),a("th",null,"Jabatan"),a("th",null,"Tanggal"),a("th",null,"Status"),a("th",null,"Keterangan")])],-1),Ae={class:"p-datatable-tbody"},qe={key:0},Me={key:1},Re={key:2},ze={class:"grid"},Ye=a("div",{class:"col-12 md:col-6"},[a("div",{class:"flex flex-wrap md:gap-3 justify-content-between align-items-stretch md:justify-content-start"})],-1),Je={class:"col-12 md:col-6"},He={class:"flex flex-wrap justify-content-end"},Ge={class:"flex flex-column align-items-center justify-content-center"},Ke=a("i",{class:"pi pi-exclamation-triangle mr-3",style:{"font-size":"2rem"}},null,-1),We={key:0},Qe=a("div",{class:"flex align-items-center justify-content-center"},[a("i",{class:"pi pi-exclamation-triangle mr-3",style:{"font-size":"2rem"}}),a("span",null,"Masukkan Catatan")],-1);function Xe(i,e,r,l,s,d){var I,N,T;const q=_("Toast"),M=_("Tag"),w=_("Label"),R=_("AutoComplete"),S=_("ErrorMsg"),D=_("InputText"),E=_("Calendar"),C=_("Column"),k=_("Button"),z=_("InputNumber"),Y=_("Dropdown"),J=_("DataTable"),H=_("SubmitButton"),L=_("Dialog"),G=_("Textarea"),j=ee("select-all-text");return u(),g("div",oe,[a("div",de,[a("div",ue,[n(q),a("h5",null,[f(c(this.isEdit?"Ubah":"Tambah")+" Penerimaan Barang ",1),n(M,{style:{float:"right"},value:i.$h.getLabel(s.item.status),severity:i.$h.getLabel(s.item.status)},null,8,["value","severity"])]),me,a("div",ce,[a("div",he,[n(w,{required:""},{default:p(()=>[f("Nomor Pesanan")]),_:1}),n(R,{id:"purchase_order",modelValue:s.selectedPurchaseOrder,"onUpdate:modelValue":e[0]||(e[0]=t=>s.selectedPurchaseOrder=t),optionLabel:"nomor",suggestions:s.filteredPurchaseOrder,onComplete:d.searchPurchaseOrder,onItemSelect:d.selectPurchaseOrder,dropdown:"",class:P({"p-invalid":d.FormError.id_po})},{option:p(t=>[a("div",pe,[a("small",ge,c(i.$h.formatDate(t.option.tanggal)),1),a("div",_e,c(t.option.referensi),1),a("div",fe,c(t.option.nomor),1),a("div",be,c(t.option.supplier),1)])]),_:1},8,["modelValue","suggestions","onComplete","onItemSelect","class"]),n(S,{error:d.FormError.id_po},null,8,["error"])]),a("div",ye,[n(w,{required:""},{default:p(()=>[f("Supplier")]),_:1}),n(D,{modelValue:s.item.supplier,"onUpdate:modelValue":e[1]||(e[1]=t=>s.item.supplier=t),disabled:""},null,8,["modelValue"])]),s.gudangStore.count>1?(u(),g("div",ve,[n(w,{required:""},{default:p(()=>[f("Gudang")]),_:1}),n(D,{value:s.item.gudang,disabled:""},null,8,["value"])])):y("",!0),we,a("div",ke,[n(w,{required:""},{default:p(()=>[f("Tanggal")]),_:1}),n(E,{modelValue:s.item.tanggal,"onUpdate:modelValue":e[2]||(e[2]=t=>s.item.tanggal=t),inputId:"tanggal",dateFormat:"dd-mm-yy",maxDate:i.$h.today,class:P({"p-invalid":d.FormError.tanggal}),showIcon:"",iconDisplay:"input"},null,8,["modelValue","maxDate","class"]),n(S,{error:d.FormError.tanggal},null,8,["error"])]),a("div",Se,[n(w,{required:""},{default:p(()=>[f("Nomor")]),_:1}),n(D,{id:"nomor",type:"text",modelValue:s.item.nomor,"onUpdate:modelValue":e[3]||(e[3]=t=>s.item.nomor=t),disabled:""},null,8,["modelValue"])]),a("div",De,[n(w,{required:""},{default:p(()=>[f("Nomor Referensi")]),_:1}),V(n(D,{id:"referensi",type:"text",modelValue:s.item.referensi,"onUpdate:modelValue":e[4]||(e[4]=t=>s.item.referensi=t),class:P({"p-invalid":d.FormError.referensi})},null,8,["modelValue","class"]),[[j]]),n(S,{error:d.FormError.referensi},null,8,["error"])]),a("div",Pe,[n(w,{required:""},{default:p(()=>[f("Tanggal Referensi")]),_:1}),n(E,{modelValue:s.item.tanggal_referensi,"onUpdate:modelValue":e[5]||(e[5]=t=>s.item.tanggal_referensi=t),inputId:"tanggal_referensi",dateFormat:"dd-mm-yy",class:P({"p-invalid":d.FormError.tanggal_referensi}),showIcon:"",iconDisplay:"input"},null,8,["modelValue","class"]),n(S,{error:d.FormError.tanggal_referensi},null,8,["error"])]),a("div",xe,[n(J,{value:s.item.detail,editMode:"cell",onCellEditComplete:d.onCellEditComplete,tableClass:"editable-cells-table p-datatable-small",tableStyle:"width:100%"},{default:p(()=>[n(C,{header:"#",headerStyle:"width:10px;"},{body:p(({index:t})=>[f(c(t+1),1)]),_:1}),n(C,{header:"Tipe",headerStyle:"width:5%;"},{body:p(({data:t})=>[a("div",Ce,[n(k,{icon:t.type=="produk"?"pi pi-box":"pi pi-briefcase",severity:t.type=="produk"?"primary":"secondary"},null,8,["icon","severity"]),a("span",je,c(t.type),1)])]),_:1}),(u(!0),g(B,null,A(s.columns,t=>(u(),v(C,{key:t.field,class:P(t.class),field:t.field,header:t.header,headerStyle:t.width},te({body:p(({data:m,field:h,index:b})=>[t.type=="number"?(u(),g("div",Ve,c(i.$h.formatNumber(m[h])),1)):h=="selectedSatuan"?(u(),g("div",Fe,c(m[h]&&m[h].satuan),1)):h=="nama_barang"?(u(),g("div",Oe,[m.type=="produk"?(u(),g("span",Ee,[a("small",Le,c(m.kode_barang),1),a("span",null,c(m.nama_barang),1)])):(u(),g("span",Ie,c(m.nama_barang),1))])):(u(),g("div",Ne,c(m[h]),1)),d.FormError.detail&&d.FormError.detail[b]?(u(),v(S,{key:4,error:d.FormError.detail[b][t.error?t.error:h]},null,8,["error"])):y("",!0)]),_:2},[s.item.status!="C"&&t.editor?{name:"editor",fn:p(({data:m,field:h})=>[h=="diambil"?V((u(),v(z,{key:0,modelValue:m[h],"onUpdate:modelValue":b=>m[h]=b,id:"diambil",inputId:"minmax",min:0,minFractionDigits:1,maxFractionDigits:5,class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue"])),[[j]]):h=="selectedSatuan"?(u(),v(Y,{key:1,modelValue:m[h],"onUpdate:modelValue":b=>m[h]=b,id:"satuan",options:m.option_satuan,optionLabel:"satuan",class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue","options"])):h=="note"?V((u(),v(D,{key:2,modelValue:m[h],"onUpdate:modelValue":b=>m[h]=b,class:"min-w-max"},null,8,["modelValue","onUpdate:modelValue"])),[[j]]):y("",!0)]),key:"0"}:void 0]),1032,["class","field","header","headerStyle"]))),128))]),_:1},8,["value","onCellEditComplete"]),n(S,{error:d.FormError.detail},null,8,["error"])])]),((I=s.item.persetujuan)==null?void 0:I.length)>0&&!this.$route.query.revisi?(u(),g("div",Te,[a("table",Ue,[Be,a("tbody",Ae,[(u(!0),g(B,null,A(s.item.persetujuan,(t,m)=>(u(),g("tr",{key:m},[a("td",null,c(m+1),1),a("td",null,c(t.nama),1),a("td",null,c(t.jabatan),1),a("td",null,c(i.$h.formatDate(t.tanggal_persetujuan,"DD-MM-YYYY HH:mm:ss")),1),t.tanggal_persetujuan!=null&&!t.status?(u(),g("td",qe,"Reject")):t.tanggal_persetujuan!=null&&t.status?(u(),g("td",Me,"Approve")):(u(),g("td",Re,"Menunggu Persetujuan")),a("td",null,c(t.keterangan),1)]))),128))])])])):y("",!0),a("div",ze,[Ye,a("div",Je,[a("div",He,[!d.canPersetujuan&&!((T=(N=s.item.persetujuan)==null?void 0:N[0])!=null&&T.tanggal_persetujuan)&&s.item.status!="C"?(u(),v(H,{key:0,loading:i.$isLoading.value,data:s.item,onClick:e[6]||(e[6]=t=>{var m;return d.Save((m=s.settingStore.pembelian.persetujuan.penerimaan)!=null&&m.persetujuan1?"S":"C")}),onDraft:e[7]||(e[7]=t=>d.Save("D")),showDraft:s.item.status=="D"||s.item.status==null},null,8,["loading","data","showDraft"])):y("",!0),s.item.status=="S"&&d.canPersetujuan?(u(),v(k,{key:1,label:"Reject",severity:"danger",iconPos:"right",icon:"pi pi-times",onClick:d.confirmReject,class:"mx-2"},null,8,["onClick"])):y("",!0),s.item.status=="S"&&d.canPersetujuan?(u(),v(k,{key:2,label:"Approve",severity:"success",iconPos:"right",icon:"pi pi-check",onClick:d.confirmApprove},null,8,["onClick"])):y("",!0)])])])]),n(L,{visible:s.closingDialog,"onUpdate:visible":e[10]||(e[10]=t=>s.closingDialog=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:p(()=>[n(k,{label:"No",icon:"pi pi-times",class:"p-button-text",onClick:e[8]||(e[8]=t=>s.closingDialog=!1)}),n(k,{label:"Yes",icon:"pi pi-check",class:"p-button-text",onClick:e[9]||(e[9]=t=>d.Save("C"))})]),default:p(()=>[a("div",Ge,[Ke,s.item?(u(),g("span",We,[f("Are you sure you want to close this "),a("b",null,c(s.item.nomor),1),f("?")])):y("",!0)])]),_:1},8,["visible"]),n(L,{visible:s.showPersetujuanDialog,"onUpdate:visible":e[14]||(e[14]=t=>s.showPersetujuanDialog=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:p(()=>[n(k,{label:"Close",icon:"pi pi-times",class:"p-button-text text-red-500",onClick:e[12]||(e[12]=t=>s.showPersetujuanDialog=!1)}),n(k,{label:i.isApprove?"Approve":"Reject",icon:"pi pi-check",class:"p-button-text",onClick:e[13]||(e[13]=t=>d.submitPersetujuan(i.isApprove))},null,8,["label"])]),default:p(()=>[Qe,n(G,{class:"w-full",modelValue:s.item.keterangan,"onUpdate:modelValue":e[11]||(e[11]=t=>s.item.keterangan=t),rows:"5",cols:"30",placeholder:"Optional"},null,8,["modelValue"])]),_:1},8,["visible"])])])}const nt=X(ne,[["render",Xe]]);export{nt as default};
